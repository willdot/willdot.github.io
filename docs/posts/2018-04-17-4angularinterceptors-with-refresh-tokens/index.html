<!DOCTYPE html>
<html lang="en-gb">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Angular Interceptors with some refresh token usage | Willdot</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Following on from the Refresh Token post, I thought I would do a quick how to on using this in an Angular app. I heard someone talking about interceptors in Angular and thought I would investigate as they sounded useful. Once I had figured out what they did and how simple they are, it made sense to use them to implement the refresh tokens.
Interceptors are a piece of code that get run on every http request that the app makes.">
    <meta name="generator" content="Hugo 0.99.1" />
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    
    
    
      

    

    
    
    <meta property="og:title" content="Angular Interceptors with some refresh token usage" />
<meta property="og:description" content="Following on from the Refresh Token post, I thought I would do a quick how to on using this in an Angular app. I heard someone talking about interceptors in Angular and thought I would investigate as they sounded useful. Once I had figured out what they did and how simple they are, it made sense to use them to implement the refresh tokens.
Interceptors are a piece of code that get run on every http request that the app makes." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://willdot.github.io/posts/2018-04-17-4angularinterceptors-with-refresh-tokens/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-04-17T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-04-17T00:00:00+00:00" />

<meta itemprop="name" content="Angular Interceptors with some refresh token usage">
<meta itemprop="description" content="Following on from the Refresh Token post, I thought I would do a quick how to on using this in an Angular app. I heard someone talking about interceptors in Angular and thought I would investigate as they sounded useful. Once I had figured out what they did and how simple they are, it made sense to use them to implement the refresh tokens.
Interceptors are a piece of code that get run on every http request that the app makes."><meta itemprop="datePublished" content="2018-04-17T00:00:00+00:00" />
<meta itemprop="dateModified" content="2018-04-17T00:00:00+00:00" />
<meta itemprop="wordCount" content="508">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Angular Interceptors with some refresh token usage"/>
<meta name="twitter:description" content="Following on from the Refresh Token post, I thought I would do a quick how to on using this in an Angular app. I heard someone talking about interceptors in Angular and thought I would investigate as they sounded useful. Once I had figured out what they did and how simple they are, it made sense to use them to implement the refresh tokens.
Interceptors are a piece of code that get run on every http request that the app makes."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Willdot
      
    </a>
    <div class="flex-l items-center">
      

      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">Angular Interceptors with some refresh token usage</h1>
      
      <p class="tracked">
        By <strong>Will Andrews</strong>
      </p>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2018-04-17T00:00:00Z">April 17, 2018</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>Following on from the Refresh Token post, I thought I would do a quick how to on using this in an Angular app. I heard someone talking about interceptors in Angular and thought I would investigate as they sounded useful. Once I had figured out what they did and how simple they are, it made sense to use them to implement the refresh tokens.</p>
<p>Interceptors are a piece of code that get run on every http request that the app makes. This means, that if you are setting headers for authorization (like my app is), you can handle this code in one place for all http request. Nice. It then got me thinking, well if the interceptor receives a 401 result, then lets try and use the refresh token and then try the original http request again.</p>
<p>So, first of all you need to create an interceptor.ts file with some code. I decided to add it into an _auth folder.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#75715e">// Basic setup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">@Injectable</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TokenInterceptor</span> <span style="color:#66d9ef">implements</span> <span style="color:#a6e22e">HttpInterceptor</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">constructor</span>(<span style="color:#66d9ef">private</span> <span style="color:#a6e22e">router</span>: <span style="color:#66d9ef">Router</span>, <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">auth</span>: <span style="color:#66d9ef">AccountService</span>, <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">_http</span>: <span style="color:#66d9ef">HttpClient</span>) {
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>    <span style="color:#75715e">// Method that clones the incoming request and adds the headers to it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">addHeaders</span>(<span style="color:#a6e22e">req</span>: <span style="color:#66d9ef">HttpRequest</span>&lt;<span style="color:#f92672">any</span>&gt;, <span style="color:#a6e22e">token</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">HttpRequest</span>&lt;<span style="color:#f92672">any</span>&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">clone</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">setHeaders</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">Authorization</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`Bearer </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">token</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#39;Content-Type&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;application/json&#39;</span>       
</span></span><span style="display:flex;"><span>        }});
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>This bit of code is doing quite a lot, but it send the request, adding the headers in. If it succeeds, great, if not, then if there is a 401 response, it tries to use the refresh token or if it&rsquo;s a 400 then it will log the user out.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>    <span style="color:#75715e">/// When a http request is sent from a service, this method is called first and it &#39;intercepts&#39; the request and does anything you tell it to.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">intercept</span>(<span style="color:#a6e22e">request</span>: <span style="color:#66d9ef">HttpRequest</span>&lt;<span style="color:#f92672">any</span>&gt;, <span style="color:#a6e22e">next</span>: <span style="color:#66d9ef">HttpHandler</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Observable</span>&lt;<span style="color:#f92672">HttpEvent</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">any</span>&gt;<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">next</span>.<span style="color:#a6e22e">handle</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">addHeaders</span>(<span style="color:#a6e22e">request</span>, <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">getItem</span>(<span style="color:#e6db74">&#39;id_token&#39;</span>)))
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">///If there is an error response and it&#39;s 401, try and do th refresh token and then send the request again
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .<span style="color:#66d9ef">catch</span>((<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">source</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">instanceof</span> <span style="color:#a6e22e">HttpErrorResponse</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">status</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">401</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">refreshToken</span>()
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">concatMap</span>(() <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">next</span>.<span style="color:#a6e22e">handle</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">addHeaders</span>(<span style="color:#a6e22e">request</span>, <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">getItem</span>(<span style="color:#e6db74">&#39;id_token&#39;</span>))).<span style="color:#66d9ef">catch</span>( <span style="color:#a6e22e">error</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Observable</span>.<span style="color:#66d9ef">throw</span>(<span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>            }));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">///If it&#39;s a bad request, then log the user out as it&#39;s probably due to the refresh token not being valid.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">instanceof</span> <span style="color:#a6e22e">HttpErrorResponse</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">status</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">400</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">logOutUser</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Observable</span>.<span style="color:#66d9ef">throw</span>(<span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>    <span style="color:#75715e">// Send an api call to use a refesh token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">refreshToken</span>() <span style="color:#f92672">:</span> <span style="color:#a6e22e">Observable</span>&lt;<span style="color:#f92672">any</span>&gt; {
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">tokenRequest</span> :<span style="color:#66d9ef">ITokenRefresh</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">refreshToken</span> : <span style="color:#66d9ef">localStorage.getItem</span>(<span style="color:#e6db74">&#39;refresh_token&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">email</span>: <span style="color:#66d9ef">localStorage.getItem</span>(<span style="color:#e6db74">&#39;currentUser&#39;</span>)
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">body</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">tokenRequest</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_http</span>.<span style="color:#a6e22e">post</span>&lt;<span style="color:#f92672">ITokenRefresh</span>&gt;(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_authenicateUrl</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;UseRefreshToken&#39;</span>, <span style="color:#a6e22e">body</span>)
</span></span><span style="display:flex;"><span>        .<span style="color:#66d9ef">do</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">data</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#e6db74">&#39;id_token&#39;</span>, <span style="color:#a6e22e">data</span>[<span style="color:#e6db74">&#39;token&#39;</span>]);
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#e6db74">&#39;token_expiry&#39;</span>, <span style="color:#a6e22e">data</span>[<span style="color:#e6db74">&#39;expiry&#39;</span>].<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#a6e22e">data</span>[<span style="color:#e6db74">&#39;refreshToken&#39;</span>]);
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#e6db74">&#39;refresh_token_expiry&#39;</span>, <span style="color:#a6e22e">data</span>[<span style="color:#e6db74">&#39;refreshTokenExpiry&#39;</span>].<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        .<span style="color:#66d9ef">catch</span>( <span style="color:#a6e22e">error</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Observable</span>.<span style="color:#66d9ef">throw</span>(<span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>    <span style="color:#75715e">// Log the user out
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">logOutUser() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#e6db74">&#39;currentUser&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#e6db74">&#39;id_token&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#e6db74">&#39;token_expiry&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#e6db74">&#39;refresh_token&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#e6db74">&#39;refresh_token_expiry&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">navigate</span>([<span style="color:#e6db74">&#39;/account&#39;</span>]);
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>    <span style="color:#75715e">// Handles an error response
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">handleError</span>(<span style="color:#a6e22e">err</span>: <span style="color:#66d9ef">HttpErrorResponse</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">error</span>);        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Observable</span>.<span style="color:#66d9ef">throw</span>(<span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Also need to add this into the app.module files providers.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">providers</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">provide</span>: <span style="color:#66d9ef">HTTP_INTERCEPTORS</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">useClass</span>: <span style="color:#66d9ef">TokenInterceptor</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">multi</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ]
</span></span></code></pre></div><p>And that&rsquo;s it!</p>
<p>Example of this being used can be found in my DailyDo web app repo.
<a href="https://github.com/willdot/DailyDo/tree/master/DailyDo.WebApplication">https://github.com/willdot/DailyDo/tree/master/DailyDo.WebApplication</a></p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://willdot.github.io" >
    &copy;  Willdot 2022 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
